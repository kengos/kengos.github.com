---
layout: posts
title: Rails CVE-2015-7576 で見る タイミングアタック(Timing Attack)
js_files: []
tags: [Rails, セキュリティ]
---

Rails 4.2.5.1 がリリースされました

いくつかのセキュリティフィックスのリリースです

あまり重要ではないですが、 CVE-2015-7576 の対応について見てみます

<a href="https://github.com/rails/rails/commit/036bbda9eb3b3885223d53646777733a1547d89a" target="_blank">対象のコミット</a>はこちらです

## 問題となったコード

`http_basic_authenticate_with` を使ったBasic認証の際にタイミングアタックの脆弱性がありました

<pre><code>authenticate_or_request_with_http_basic(options[:realm] || "Application") do |name, password|
  name == options[:name] && password == options[:password]
end</code></pre>

`http_basic_authenticate_with` は以下のように Controllerに書くことで利用できます

<pre><code>http_basic_authenticate_with name: 'user', password: 'password'</code></pre>

## そもそもタイミングアタックとはなんなのか?

以下の2つのコードはどちらが実行時間が早いでしょうか?

<pre><code># コードA
'foo' == 'bar'
# コードB
'bar' == 'baz'</code></pre>

<strong>ms以下のレベル</strong>になるのですが、コードBのほうが実行時間が長くなります

<ul>
<li>コードAは1文字目が異なるので、1文字目で比較判定を打ち切ります</li>
<li>コードBは1文字目が同じで<strong>2文字目が異なるので</strong> 2文字目で比較判定を打ち切ります</li>
</ul>

そのため、コードBは1文字分だけ実行時間が長くなります

<div class="ui message">
<p>この実行時間の違いを検出して<strong>パスワード等で利用されている文字を推測する</strong>のがタイミングアタックと呼ばれる攻撃のようです</p>
</div>

## CVE-2015-7956 の修正コード

<pre><code>authenticate_or_request_with_http_basic(options[:realm] || "Application") do |name, password|
  ActiveSupport::SecurityUtils.variable_size_secure_compare(name, options[:name]) &amp;
    ActiveSupport::SecurityUtils.variable_size_secure_compare(password, options[:password])
end</code></pre>

<ul>
<li>`ActiveSupport::SecurityUtils.variable_size_secure_compare` を使用するように変更されている</li>
<li><strong>&amp;&amp;</strong> から <strong>&amp;</strong> のみとなっている</li>
</ul>

## ActiveSupport::SecurityUtils.variable_size_secure_compare

入力文字列を SHA256 のハッシュ文字列に変換後 byte単位での比較をしています

<pre><code>def variable_size_secure_compare(a, b) # :nodoc:
  secure_compare(::Digest::SHA256.hexdigest(a), ::Digest::SHA256.hexdigest(b))
end</code></pre>

ハッシュ関数を通し、`ActiveSupport::SecurityUtils.secure_compare` を利用することで

文字長の違いからのタイミングアタックを防止しているようです

## まとめ

ユーザからの入力文字列とサーバ上のセキュアなもの(パスワードとか)を比較する際には

`ActiveSupport::SecurityUtils.variable_size_secure_compare`

を利用するようにしたほうが良さそう

## その他

`Rails Basic認証`等で検索すると以下のようなコードが散見されます

<pre><code>authenticate_or_request_with_http_basic do |user, pass|
  user == 'user' && pass == 'pass'
end</code></pre>

(サーバのスペック向上に伴いタイミングアタック自体が成立しにくくなっているとはいえ)

#### バージョンアップ後のRails標準の`http_basic_authenticate_with`を利用する

#### 以下のように今回の対策と同じコードとしておく

<pre><code>authenticate_or_request_with_http_basic do |user, pass|
ActiveSupport::SecurityUtils.variable_size_secure_compare(name, 'user') &amp;
  ActiveSupport::SecurityUtils.variable_size_secure_compare(password, 'password')
end</code></pre>