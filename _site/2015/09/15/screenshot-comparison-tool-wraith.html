<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# fb: http://www.facebook.com/2008/fbml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スクリーンショット比較ツール "Wraith"</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/syntax.css">
<link rel="author" href="https://plus.google.com/102187337938024275663/posts">
<meta name="google-site-verification" content="0lvnSNpPQpx5PVeFdlOeEGWG4ayedwnXKG3OcQKp_Ys">
<meta property="og:title" content="スクリーンショット比較ツール "Wraith"">
<meta property="og:type" content="article">
<meta property="og:url" content="http://kengos.jp/2015/09/15/screenshot-comparison-tool-wraith.html">
<meta property="og:site_name" content="kengos.jp">
<meta property="og:locale" content="ja">

<!-- ga -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40855269-1', 'kengos.jp');
  ga('send', 'pageview');
</script>
</head>
<body>
<nav id="navigation">
  <div class="nav-wrapper">
    <a href="http://kengos.jp/" class="brand-logo">kengos.jp</a>
    <a href="#" data-activates="mobile-navigation" class="button-collapse"><i class="mdi-navigation-menu"></i></a>
    <ul class="right hide-on-med-and-down">
      <li><a href="/posts.html">Blog</a></li>
    </ul>
    <ul class="side-nav" id="mobile-navigation">
      <li><a href="/posts.html">Blog</a></li>
    </ul>
  </div>
</nav>
<div class="container">
  <div id="main" class="row">
    <div class="col s12">
      <div class="right-align">
  <p>2015-09-15</p>
</div>
<h2>
  <a href="/2015/09/15/screenshot-comparison-tool-wraith.html" >スクリーンショット比較ツール "Wraith"</a>
</h2>
<div class="right-align tags">
  Tag:
  
  <span class="badge">スクリーンショット比較</span>
  
</div>
<div class="posts">
<iframe width="560" height="315" src="https://www.youtube.com/embed/gE_19L0l2q0" frameborder="0" allowfullscreen=""></iframe>

<h2 id="section">はじめに</h2>

<p>スクリーンショットの比較ツールである <strong>“Wraith”</strong>の紹介です。</p>

<p><a href="https://github.com/BBC-News/wraith">Github</a><br />
<a href="http://bbc-news.github.io/wraith/index.html">Document</a></p>

<p>これを利用すると CSSの変更時の見た目の差分のチェックなどができます。</p>

<p><img src="/images/20150915/20150915_1.png" alt="実行後のイメージ" style="max-width:80%;" /></p>

<p>左が 開発環境, 右が今の本番の状態です。</p>

<p><img src="/images/20150915/20150915_2.png" alt="差分表示のイメージ" style="max-width:80%;" /></p>

<p>diff のイメージをクリックすると差分の箇所が青くなっている画像が表示されます。</p>

<p>今回は 表示されている画像の width を 100% にしてしまっていたため、縦長の画像が拡大されすぎていたのを修正しました。</p>

<p>1/6 ほど幅が狭くなっている感じですね。</p>

<h2 id="section-1">インストール</h2>

<p>OS X 10.10 系 + <a href="http://brew.sh/index_ja.html">homebrew</a> の環境でインストールしていきます。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>brew -v
Homebrew 0.9.5 <span class="o">(</span>git revision 4c6e7; last commit 2015-09-12<span class="o">)</span>
<span class="gp">$ </span>ruby -v
ruby 2.2.3p173 <span class="o">(</span>2015-08-18 revision 51636<span class="o">)</span> <span class="o">[</span>x86_64-darwin14]
</code></pre>
</div>

<h3 id="phantomjs-imagemagick-">phantomjs, imagemagick のインストール</h3>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>brew install phantomjs imagemagick
</code></pre>
</div>

<p>(すでに入っていたので,入っていない場合の挙動は不明)</p>

<h3 id="wraith-">Wraith のインストール</h3>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>gem install wraith
</code></pre>
</div>

<p>rbenv の場合は <code class="highlighter-rouge">rehash</code> すること</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>rbenv rehash
</code></pre>
</div>

<h2 id="wraith--1">Wraith の設定</h2>

<p>任意のディレクトリを作成して、そこに移動して作業します。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mkdir -p ~/wraith
<span class="gp">$ </span><span class="nb">cd</span> ~/wraith
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>wraith setup
</code></pre>
</div>

<p>configs/config.yaml というファイルができています。</p>

<p>そのファイルに設定をいれていきます。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>vi configs/config.yaml
</code></pre>
</div>

<p>下のような感じで設定しました。</p>

<p>ポイントとなるのは <strong>domains</strong>, <strong>screen_widths</strong>, <strong>paths</strong> でしょうか。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">browser</span><span class="pi">:</span>
  <span class="s">phantomjs</span><span class="pi">:</span> <span class="s2">"</span><span class="s">phantomjs"</span>

<span class="s">snap_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">javascript/snap.js"</span>

<span class="s">directory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">shots'</span>

<span class="s">domains</span><span class="pi">:</span>
  <span class="s">production</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://kengos.jp"</span> <span class="c1"># 元となるページのドメイン</span>
  <span class="s">develpoment</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://localhost:4000"</span> <span class="c1"># 比較したいページのドメイン</span>

<span class="c1"># チェックしたい画面幅(この場合は 320px, 600px, 1280px の3種類)</span>
<span class="s">screen_widths</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">320</span>
  <span class="pi">-</span> <span class="s">600</span>
  <span class="pi">-</span> <span class="s">1280</span>

<span class="c1"># チェックするパス</span>
<span class="c1"># この場合は "/" と "/2015/09/13/password.html" の 2つのパス</span>
<span class="s">paths</span><span class="pi">:</span>
  <span class="s">home</span><span class="pi">:</span> <span class="s">/</span>
  <span class="s">2015_09_13</span><span class="pi">:</span> <span class="s">/2015/09/13/password.html</span>

<span class="s">fuzz</span><span class="pi">:</span> <span class="s1">'</span><span class="s">20%'</span>

<span class="s">spider_days</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">10</span>

<span class="s">mode</span><span class="pi">:</span> <span class="s">diffs_first</span>

<span class="s">threshold</span><span class="pi">:</span> <span class="s">5</span>
</code></pre>
</div>

<h2 id="wraith--2">Wraith の実行</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>wraith capture configs/config.yaml
</code></pre>
</div>

<p>しばらく待つと 以下のように <strong>shots</strong> というディレクトリができ、内部に画像ができています。</p>

<p><img src="/images/20150915/20150915_3.png" alt="ディレクトリ構造" style="max-width:100%;" /></p>

<p><strong>gallery.html</strong>をブラウザで開くことで、冒頭の画像が表示されます。</p>

<h2 id="compare">どうやって Compareしているの？</h2>

<p>Capture程度であれば phantomjs を簡単に触ればできてしまいます。</p>

<p>一番気になったのが, Compareのやり方。</p>

<p>Openソースなので ソースコードを見ればわかる！っていうのがいいですよね。</p>

<p><a href="https://github.com/BBC-News/wraith/blob/master/lib/wraith/compare_images.rb#L30">Compareの該当ソースの場所</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compare_task</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
  <span class="n">cmdline</span> <span class="o">=</span> <span class="s2">"compare -dissimilarity-threshold 1 -fuzz </span><span class="si">#{</span><span class="n">wraith</span><span class="p">.</span><span class="nf">fuzz</span><span class="si">}</span><span class="s2"> -metric AE -highlight-color </span><span class="si">#{</span><span class="n">wraith</span><span class="p">.</span><span class="nf">highlight_color</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">base</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">compare</span><span class="p">.</span><span class="nf">shellescape</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">output</span><span class="si">}</span><span class="s2">"</span>
  <span class="n">px_value</span> <span class="o">=</span> <span class="no">Open3</span><span class="p">.</span><span class="nf">popen3</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">_stdin</span><span class="p">,</span> <span class="n">_stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">_wait_thr</span><span class="o">|</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">read</span> <span class="p">}.</span><span class="nf">to_f</span>
  <span class="k">begin</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="no">ImageSize</span><span class="p">.</span><span class="nf">path</span><span class="p">(</span><span class="n">output</span><span class="p">).</span><span class="nf">size</span><span class="p">.</span><span class="nf">inject</span><span class="p">(:</span><span class="o">*</span><span class="p">)</span>
    <span class="n">percentage</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">px_value</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
  <span class="k">rescue</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"invalid"</span><span class="p">)</span> <span class="p">}</span> <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ImageMagick の compareコマンドを使っていることがわかりますね。</p>

<p><a href="http://www.imagemagick.org/script/compare.php">ImageMagick-compare</a></p>

<p>該当のソースの箇所のオプション値を調整/変更することで、自分のサイトに合った調整にできるかもしれないですね。</p>

<p>(compareコマンドの使い方調べてないのでわからない)</p>

<h2 id="section-2">最後に</h2>

<p>単体だと中々使いにくいなという感じがします。</p>

<p>CI に組み込んだり、Wraith をライブラリとして利用した簡単なWebアプリケーションを作り、</p>

<p>簡単に設定、実行できるようにしたりなどするといい感じになるかもしれませんね。</p>

</div>
    </div>
  </div>
</div>
<footer class="page-footer">
  <div class="container">
    <div class="row">
      <div class="col s12">
        <div id="social-button"></div>
      </div>
    </div>
  </div>
  <div class="footer-copyright">
    <div class="container">&copy; kengos 2013</div>
  </div>
</footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
<script src="/js/jquery.popn-socialbutton.js"></script>
<script>
(function($){
  $('#social-button').popnSocialButton([ 'twitter', 'facebook', 'hatebu', 'gplus', 'pocket' ]);
  $(".button-collapse").sideNav();
})(jQuery);
</script>
</body>
</html>